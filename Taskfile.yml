version: '3'

vars:
  BINARY_NAME: terraform-provider-uptrace
  GOBIN: '{{.ROOT_DIR}}/bin'

env:
  CGO_ENABLED: "0"

tasks:
  default:
    desc: List available tasks
    cmds:
      - task --list

  deps:
    desc: Install development dependencies
    cmds:
      - go install github.com/deepmap/oapi-codegen/v2/cmd/oapi-codegen@latest
      - go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
      - go install github.com/hashicorp/terraform-plugin-docs/cmd/tfplugindocs@latest
      - go mod download

  generate:
    desc: Generate code from OpenAPI spec
    deps: [deps]
    sources:
      - api/openapi.yaml
      - oapi-codegen.yaml
    generates:
      - internal/client/generated/*.go
    cmds:
      - mkdir -p internal/client/generated
      - oapi-codegen -config oapi-codegen.yaml api/openapi.yaml

  build:
    desc: Build the provider binary
    deps: [generate]
    sources:
      - '**/*.go'
      - go.mod
      - go.sum
    generates:
      - '{{.BINARY_NAME}}'
    cmds:
      - go build -o {{.BINARY_NAME}} -ldflags="-s -w" .

  install:
    desc: Install provider to local Terraform plugins directory
    deps: [build]
    vars:
      VERSION: '0.1.0'
      OS: '{{OS}}'
      ARCH: '{{ARCH}}'
      PLUGIN_DIR: '~/.terraform.d/plugins/registry.terraform.io/riccap/uptrace/{{.VERSION}}/{{.OS}}_{{.ARCH}}'
    cmds:
      - mkdir -p {{.PLUGIN_DIR}}
      - cp {{.BINARY_NAME}} {{.PLUGIN_DIR}}/

  test:
    desc: Run unit tests
    cmds:
      - go test -v -cover -race ./...

  test:coverage:
    desc: Run tests with coverage report
    cmds:
      - go test -v -coverprofile=coverage.txt -covermode=atomic ./...
      - go tool cover -html=coverage.txt -o coverage.html
      - echo "Coverage report generated at coverage.html"

  testacc:
    desc: Run acceptance tests
    env:
      TF_ACC: "1"
    cmds:
      - |
        if [ -z "$UPTRACE_ENDPOINT" ] || [ -z "$UPTRACE_TOKEN" ]; then
          echo "Error: UPTRACE_ENDPOINT and UPTRACE_TOKEN must be set"
          exit 1
        fi
      - go test -v -cover -timeout 30m ./...

  lint:
    desc: Run linters
    deps: [generate]
    cmds:
      - golangci-lint run --timeout 5m

  lint:fix:
    desc: Run linters and auto-fix issues
    deps: [generate]
    cmds:
      - golangci-lint run --fix --timeout 5m

  fmt:
    desc: Format code
    cmds:
      - gofmt -s -w .
      - go mod tidy

  docs:
    desc: Generate provider documentation
    deps: [build]
    cmds:
      - tfplugindocs generate --provider-name uptrace

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -f {{.BINARY_NAME}}
      - rm -f coverage.txt coverage.html
      - rm -rf dist/
      - rm -rf .test/

  clean:all:
    desc: Clean all generated files including client code
    deps: [clean]
    cmds:
      - rm -rf internal/client/generated/

  validate:
    desc: Run all validation checks
    deps: [generate]
    cmds:
      - task: fmt
      - task: lint
      - task: test

  release:
    desc: Create a new release (dry-run)
    cmds:
      - goreleaser release --snapshot --clean

  release:publish:
    desc: Publish a new release
    cmds:
      - goreleaser release --clean

  dev:setup:
    desc: Complete development environment setup
    cmds:
      - task: deps
      - task: generate
      - task: build
      - echo "Development environment ready!"

  dev:up:
    desc: Start local Uptrace instance for testing
    dir: dev-env
    cmds:
      - docker compose up -d
      - echo "Waiting for Uptrace to be ready..."
      - |
        for i in {1..60}; do
          if docker compose logs uptrace 2>&1 | grep -q "Listening on :4317"; then
            echo "‚úÖ Uptrace is ready!"
            echo ""
            echo "üìä Web UI:        http://localhost:14318"
            echo "   Email:         uptrace@localhost"
            echo "   Password:      SomeRandomPassword"
            echo ""
            echo "Next steps:"
            echo "1. Login and create an API token"
            echo "2. Copy dev-env/terraform-test/terraform.tfvars.example to terraform.tfvars"
            echo "3. Add your token to terraform.tfvars"
            echo "4. Run: task dev:test"
            exit 0
          fi
          sleep 2
        done
        echo "‚ùå Uptrace failed to start"
        exit 1

  dev:down:
    desc: Stop local Uptrace instance
    dir: dev-env
    cmds:
      - docker compose down

  dev:reset:
    desc: Reset local Uptrace instance (removes all data)
    dir: dev-env
    cmds:
      - docker compose down -v
      - echo "All data removed. Run 'task dev:up' to start fresh."

  dev:logs:
    desc: Show Uptrace logs
    dir: dev-env
    cmds:
      - docker compose logs -f uptrace

  dev:test:
    desc: Test provider against local Uptrace
    dir: dev-env/terraform-test
    deps: [install]
    cmds:
      - terraform init -upgrade
      - terraform plan
      - echo ""
      - echo "Review the plan above. To apply, run:"
      - echo "  cd dev-env/terraform-test && terraform apply"

  dev:install-local:
    desc: Install provider locally for testing
    deps: [build]
    vars:
      VERSION: '0.1.0'
      OS: '{{OS}}'
      ARCH: '{{ARCH}}'
    cmds:
      - mkdir -p ~/.terraform.d/plugins/registry.terraform.io/riccap/uptrace/{{.VERSION}}/{{.OS}}_{{.ARCH}}
      - cp {{.BINARY_NAME}} ~/.terraform.d/plugins/registry.terraform.io/riccap/uptrace/{{.VERSION}}/{{.OS}}_{{.ARCH}}/
      - echo "Provider installed to ~/.terraform.d/plugins/registry.terraform.io/riccap/uptrace/{{.VERSION}}/{{.OS}}_{{.ARCH}}/"
